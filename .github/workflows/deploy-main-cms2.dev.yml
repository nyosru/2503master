name: Deploy to cms2dev2


env:
  VPS_IP: 91.218.230.97
  VPS_USERNAME: root
  DIR: /home/proc-master
  GIT_BRANCH: origin/main
  Username: nyosru


on:
  push:
    branches:
      - main



jobs:

  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

#      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
#        run: |
#          mkdir -p ~/.ssh
#          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
#          chmod 600 ~/.ssh/id_ed25519
#          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
#
#          # –î–æ–±–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Ö–æ—Å—Ç–∞ –≤ known_hosts –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–∫–∏ "Host key verification failed"
#          ssh-keyscan -H cms2.dev..store >> ~/.ssh/known_hosts

      - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        run: |
          ssh -i ~/.ssh/proc-master_key -o StrictHostKeyChecking=no ${{ env.VPS_USERNAME }}@${{ env.VPS_IP }} << 'EOF'
            cd ${{ env.DIR }}
            git fetch --all
            git reset --hard origin/main

            # git pull origin main
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            # systemctl restart my-app
          EOF

      - name: composer & migrate
        run: |
          ssh -i ~/.ssh/proc-master_key -o StrictHostKeyChecking=no ${{ env.VPS_USERNAME }}@${{ env.VPS_IP }} << 'EOF'
            cd ${{ env.DIR }}
            #/usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
            docker exec 2503master php composer i
            docker exec 2503master php artisan migrate
          EOF

##  deploy01:
##    runs-on: ubuntu-latest
##    steps:
##
##      - name: Run bash script via ssh to update repository on server
##        uses: appleboy/ssh-action@master
##        with:
###          host: ${{ secrets.SSH_HOST }}
###          username: ${{ secrets.SSH_USER }}
##          host: ${{ env.VPS_IP }}
##            #          username: ${{ secrets.SSH_USER }}
##          username: ${{ env.VPS_USERNAME }}
###          key-in-repo-with-write-access-only-for-this-repo-is-not-used-here-but-you-can-use-it-if-needed-for-other-actions-like-checkout-or-pull-from-private-repos-with-deploy-keys-enabled-on-them-directly-through-github-settings-not-secrets-in-actions.yml-file-for-security-reasons-and-to-follow-best-practices-of-using-deploy-keys-instead-of-secrets-for-such-scenarios
###          script: |
###            cd / && git fetch --all && git reset --hard origin/main
##          key: ${{ secrets.DEPLOY_KEY }}
##          script: |
##            ls
##            git fetch --all
##            git reset --hard origin/main
##
##  deploy00:
##    runs-on: ubuntu-latest
##    steps:
##      # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≥–µ–Ω—Ç–∞ SSH (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ HTTPS —Å —Ç–æ–∫–µ–Ω–æ–º)
##      # –ù–æ –µ—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø–æ SSH –∫ –¥—Ä—É–≥–æ–º—É —Å–µ—Ä–≤–µ—Ä—É,
##      # —Ç–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —à–∞–≥ —Å –¥—Ä—É–≥–∏–º –∫–ª—é—á–æ–º.
##
##      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —á–µ—Ä–µ–∑ Git Pull.
##      - name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Git"
##        run: |
##          git config --global user.email "1@php-cat.com"
##          git config --global user.name "–°–µ—Ä–≥–µ–π"
##          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
##
###      - name: "refresh git & restart docker"
###        uses: appleboy/ssh-action@master
###        with:
###          host: ${{ env.VPS_IP }}
###          username: ${{ env.VPS_USERNAME }}
###          key: ${{ secrets.DEPLOY_KEY }}
###          script: |
###            cd /path/to/repo && git fetch --all && git reset --hard origin/main
##      - name: Run bash script via ssh to update repository on server
##        uses: appleboy/ssh-action@master
##        with:
###          host: ${{ secrets.SSH_HOST }}
##          host: ${{ env.VPS_IP }}
###          username: ${{ secrets.SSH_USER }}
##          username: ${{ env.VPS_USERNAME }}
###          key: ${{ secrets.SSH_PRIVATE_KEY }}  # –ï—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ SSH
##          key: ${{ secrets.DEPLOY_KEY }}
##          script: |
##            ls
##            git fetch --all
##            git reset --hard origin/main
#
#  deploy:
#    runs-on: ubuntu-latest
##    needs: deploy00
#    steps:
##      - name: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Git"
##        run: |
##          git config --global credential.helper store
##          echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" > ~/.git-credentials
#
#      - name: "refresh git & restart docker"
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ env.VPS_IP }}
#          username: ${{ env.VPS_USERNAME }}
#          key: ${{ secrets.DEPLOY_KEY }}
#          script: |
#                    git fetch --all
#                    git reset --hard ${{ env.GIT_BRANCH }}
#          #            cd ${{ env.DIR }}
#
#  #  deploy_composer_stop:
#  #    runs-on: ubuntu-latest
#  #    needs: deploy
#  #    steps:
#  #      - uses: appleboy/ssh-action@master
#  #        with:
#  #          host: ${{ env.VPS_IP }}
#  #          username: ${{ env.VPS_USERNAME }}
#  #          key: ${{ secrets.DEPLOY_KEY_DOCKER24 }}
#  #          script: |
#  #            cd ${{ env.DIR }}
#  #            docker-compose down --remove-orphans
#
#
#
#
#  deploy_composer:
#    runs-on: ubuntu-latest
#    #    needs: deploy_composer_stop
#    needs: deploy
#    steps:
#      - uses: appleboy/ssh-action@master
#        with:
#
#          host: ${{ env.VPS_IP }}
#          username: ${{ env.VPS_USERNAME }}
#          key: ${{ secrets.DEPLOY_KEY }}
#
#          script: |
#            /usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
##            /usr/local/php/cgi/8.2/bin/php artisan migrate
#          #            cd ${{ env.DIR }}
#          #            /usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
#
#
#  deploy_composer_db:
#    runs-on: ubuntu-latest
#    #    needs: deploy_composer_stop
#    needs: deploy_composer
#    steps:
#      - uses: appleboy/ssh-action@master
#        with:
#
#          host: ${{ env.VPS_IP }}
#          username: ${{ env.VPS_USERNAME }}
#          key: ${{ secrets.DEPLOY_KEY }}
#
#          script: |
#            /usr/local/php/cgi/8.2/bin/php artisan migrate
#          #            cd ${{ env.DIR }}
#          #            /usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
#
#
##  deploy_npm:
##    runs-on: ubuntu-latest
##    #    needs: deploy_composer_stop
##    needs: deploy
##    steps:
##      - uses: appleboy/ssh-action@master
##        with:
##
##          host: ${{ env.VPS_IP }}
##          username: ${{ env.VPS_USERNAME }}
##          key: ${{ secrets.DEPLOY_KEY }}
##
##          script: |
##            npm i
##            npm run build
#
  sms_start:
    runs-on: ubuntu-latest
    steps:
      - name: send telega
        uses: appleboy/telegram-action@master
        with:
          # to: ${{ secrets.TELEGRAM_TO }}
          to: 360209578, phpcat,
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üê•üê•üê• ${{ github.repository }}
            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
            üë®üèª‚Äçüíª ${{github.actor}} (${{ github.run_id }})

  sms_end00:
    runs-on: ubuntu-latest
    # needs: [deploy_composer, deploy_npm]
    needs: deploy
    steps:
      - name: send telega
        uses: appleboy/telegram-action@master
        with:
          # to: ${{ secrets.TELEGRAM_TO }}
          to: 360209578, phpcat,
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üçÄüçÄüçÄ ${{ github.repository }} üë®üèª‚Äçüíª ${{github.actor}} > ${{ github.run_id }}
            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
            –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–æ—Ä–º
#
#  sms_end:
#    runs-on: ubuntu-latest
#    # needs: [deploy_composer, deploy_npm]
#    needs: deploy_composer_db
#    steps:
#      - name: send telega
#        uses: appleboy/telegram-action@master
#        with:
#          # to: ${{ secrets.TELEGRAM_TO }}
#          to: 360209578, phpcat,
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          message: |
#            üçÄüçÄüçÄ ${{ github.repository }} üë®üèª‚Äçüíª ${{github.actor}} > ${{ github.run_id }}
#            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
#            –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–æ—à–ª–∏ –Ω–æ—Ä–º
#
#
#
#  sms_end3:
#    runs-on: ubuntu-latest
#    # needs: [deploy_composer, deploy_npm]
#    needs: deploy_composer
#    steps:
#      - name: send telega
#        uses: appleboy/telegram-action@master
#        with:
#          # to: ${{ secrets.TELEGRAM_TO }}
#          to: 360209578, phpcat,
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          message: |
#            üçÄüçÄüçÄ ${{ github.repository }} üë®üèª‚Äçüíª ${{github.actor}} > ${{ github.run_id }}
#            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
#            —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–º–ø–æ–∑–µ—Ä–µ –Ω–æ—Ä–º
#
#  # –®–∞–≥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
#  sms_error:
#    runs-on: ubuntu-latest
#    if: failure()  # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
#    steps:
#      - name: send error telega
#        uses: appleboy/telegram-action@master
#        with:
#          to: 360209578, phpcat,
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          message: |
#            ‚ùå‚ùå‚ùå –û—à–∏–±–∫–∞ –≤ ${{ github.repository }}
#            –î–µ–π—Å—Ç–≤–∏–µ: ${{ github.event_name }} > ${{ github.event.head_commit.message }}
#            –û—à–∏–±–∫—É –≤—ã–∑–≤–∞–ª: üë®üèª‚Äçüíª ${{github.actor}} (${{ github.run_id }})
