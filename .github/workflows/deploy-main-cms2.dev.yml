name: Deploy to cms2dev2


env:
  VPS_IP: 91.218.230.97
  VPS_USERNAME: root
  DIR: /home/proc-master
  GIT_BRANCH: origin/main
  Username: nyosru


on:
  push:
    branches:
      - main



jobs:

  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
        uses: actions/checkout@v4

#      - name: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° SSH
#        run: |
#          mkdir -p ~/.ssh
#          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
#          chmod 600 ~/.ssh/id_ed25519
#          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
#
#          # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ñ…Ğ¾ÑÑ‚Ğ° Ğ² known_hosts Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ "Host key verification failed"
#          ssh-keyscan -H cms2.dev..store >> ~/.ssh/known_hosts

      - name: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
        run: |
          ssh -i ~/.ssh/proc-master_key -o StrictHostKeyChecking=no ${{ env.VPS_USERNAME }}@${{ env.VPS_IP }} << 'EOF'
            cd ${{ env.DIR }}
            git fetch --all
            git reset --hard origin/main

            # git pull origin main
            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ°, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
            # systemctl restart my-app
          EOF

      - name: composer & migrate
        run: |
          ssh -i ~/.ssh/proc-master_key -o StrictHostKeyChecking=no ${{ env.VPS_USERNAME }}@${{ env.VPS_IP }} << 'EOF'
            cd ${{ env.DIR }}
            #/usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
            docker exec 2503master php composer i
            docker exec 2503master php artisan migrate
          EOF

##  deploy01:
##    runs-on: ubuntu-latest
##    steps:
##
##      - name: Run bash script via ssh to update repository on server
##        uses: appleboy/ssh-action@master
##        with:
###          host: ${{ secrets.SSH_HOST }}
###          username: ${{ secrets.SSH_USER }}
##          host: ${{ env.VPS_IP }}
##            #          username: ${{ secrets.SSH_USER }}
##          username: ${{ env.VPS_USERNAME }}
###          key-in-repo-with-write-access-only-for-this-repo-is-not-used-here-but-you-can-use-it-if-needed-for-other-actions-like-checkout-or-pull-from-private-repos-with-deploy-keys-enabled-on-them-directly-through-github-settings-not-secrets-in-actions.yml-file-for-security-reasons-and-to-follow-best-practices-of-using-deploy-keys-instead-of-secrets-for-such-scenarios
###          script: |
###            cd / && git fetch --all && git reset --hard origin/main
##          key: ${{ secrets.DEPLOY_KEY }}
##          script: |
##            ls
##            git fetch --all
##            git reset --hard origin/main
##
##  deploy00:
##    runs-on: ubuntu-latest
##    steps:
##      # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ°Ğ³ĞµĞ½Ñ‚Ğ° SSH (Ğ½Ğµ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ, ĞµÑĞ»Ğ¸ Ğ²Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ HTTPS Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ¼)
##      # ĞĞ¾ ĞµÑĞ»Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒÑÑ Ğ¿Ğ¾ SSH Ğº Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¼Ñƒ ÑĞµÑ€Ğ²ĞµÑ€Ñƒ,
##      # Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ ÑˆĞ°Ğ³ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼ ĞºĞ»ÑÑ‡Ğ¾Ğ¼.
##
##      # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ´Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ñ‡ĞµÑ€ĞµĞ· Git Pull.
##      - name: "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Git"
##        run: |
##          git config --global user.email "1@php-cat.com"
##          git config --global user.name "Ğ¡ĞµÑ€Ğ³ĞµĞ¹"
##          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
##
###      - name: "refresh git & restart docker"
###        uses: appleboy/ssh-action@master
###        with:
###          host: ${{ env.VPS_IP }}
###          username: ${{ env.VPS_USERNAME }}
###          key: ${{ secrets.DEPLOY_KEY }}
###          script: |
###            cd /path/to/repo && git fetch --all && git reset --hard origin/main
##      - name: Run bash script via ssh to update repository on server
##        uses: appleboy/ssh-action@master
##        with:
###          host: ${{ secrets.SSH_HOST }}
##          host: ${{ env.VPS_IP }}
###          username: ${{ secrets.SSH_USER }}
##          username: ${{ env.VPS_USERNAME }}
###          key: ${{ secrets.SSH_PRIVATE_KEY }}  # Ğ•ÑĞ»Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ SSH
##          key: ${{ secrets.DEPLOY_KEY }}
##          script: |
##            ls
##            git fetch --all
##            git reset --hard origin/main
#
#  deploy:
#    runs-on: ubuntu-latest
##    needs: deploy00
#    steps:
##      - name: "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ÑƒÑ‡ĞµÑ‚Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Git"
##        run: |
##          git config --global credential.helper store
##          echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" > ~/.git-credentials
#
#      - name: "refresh git & restart docker"
#        uses: appleboy/ssh-action@master
#        with:
#          host: ${{ env.VPS_IP }}
#          username: ${{ env.VPS_USERNAME }}
#          key: ${{ secrets.DEPLOY_KEY }}
#          script: |
#                    git fetch --all
#                    git reset --hard ${{ env.GIT_BRANCH }}
#          #            cd ${{ env.DIR }}
#
#  #  deploy_composer_stop:
#  #    runs-on: ubuntu-latest
#  #    needs: deploy
#  #    steps:
#  #      - uses: appleboy/ssh-action@master
#  #        with:
#  #          host: ${{ env.VPS_IP }}
#  #          username: ${{ env.VPS_USERNAME }}
#  #          key: ${{ secrets.DEPLOY_KEY_DOCKER24 }}
#  #          script: |
#  #            cd ${{ env.DIR }}
#  #            docker-compose down --remove-orphans
#
#
#
#
#  deploy_composer:
#    runs-on: ubuntu-latest
#    #    needs: deploy_composer_stop
#    needs: deploy
#    steps:
#      - uses: appleboy/ssh-action@master
#        with:
#
#          host: ${{ env.VPS_IP }}
#          username: ${{ env.VPS_USERNAME }}
#          key: ${{ secrets.DEPLOY_KEY }}
#
#          script: |
#            /usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
##            /usr/local/php/cgi/8.2/bin/php artisan migrate
#          #            cd ${{ env.DIR }}
#          #            /usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
#
#
#  deploy_composer_db:
#    runs-on: ubuntu-latest
#    #    needs: deploy_composer_stop
#    needs: deploy_composer
#    steps:
#      - uses: appleboy/ssh-action@master
#        with:
#
#          host: ${{ env.VPS_IP }}
#          username: ${{ env.VPS_USERNAME }}
#          key: ${{ secrets.DEPLOY_KEY }}
#
#          script: |
#            /usr/local/php/cgi/8.2/bin/php artisan migrate
#          #            cd ${{ env.DIR }}
#          #            /usr/local/php/cgi/8.2/bin/php composer.phar i --no-dev
#
#
##  deploy_npm:
##    runs-on: ubuntu-latest
##    #    needs: deploy_composer_stop
##    needs: deploy
##    steps:
##      - uses: appleboy/ssh-action@master
##        with:
##
##          host: ${{ env.VPS_IP }}
##          username: ${{ env.VPS_USERNAME }}
##          key: ${{ secrets.DEPLOY_KEY }}
##
##          script: |
##            npm i
##            npm run build
#
  sms_start:
    runs-on: ubuntu-latest
    steps:
      - name: send telega
        uses: appleboy/telegram-action@master
        with:
          # to: ${{ secrets.TELEGRAM_TO }}
          to: 360209578, phpcat,
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ¥ğŸ¥ğŸ¥ ${{ github.repository }}
            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} (${{ github.run_id }})

  sms_end00:
    runs-on: ubuntu-latest
    # needs: [deploy_composer, deploy_npm]
    needs: deploy
    steps:
      - name: send telega
        uses: appleboy/telegram-action@master
        with:
          # to: ${{ secrets.TELEGRAM_TO }}
          to: 360209578, phpcat,
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ€ğŸ€ğŸ€ ${{ github.repository }} ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} > ${{ github.run_id }}
            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
            Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ¸ Ğ½Ğ¾Ñ€Ğ¼
#
#  sms_end:
#    runs-on: ubuntu-latest
#    # needs: [deploy_composer, deploy_npm]
#    needs: deploy_composer_db
#    steps:
#      - name: send telega
#        uses: appleboy/telegram-action@master
#        with:
#          # to: ${{ secrets.TELEGRAM_TO }}
#          to: 360209578, phpcat,
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          message: |
#            ğŸ€ğŸ€ğŸ€ ${{ github.repository }} ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} > ${{ github.run_id }}
#            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
#            Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ Ğ½Ğ¾Ñ€Ğ¼
#
#
#
#  sms_end3:
#    runs-on: ubuntu-latest
#    # needs: [deploy_composer, deploy_npm]
#    needs: deploy_composer
#    steps:
#      - name: send telega
#        uses: appleboy/telegram-action@master
#        with:
#          # to: ${{ secrets.TELEGRAM_TO }}
#          to: 360209578, phpcat,
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          message: |
#            ğŸ€ğŸ€ğŸ€ ${{ github.repository }} ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} > ${{ github.run_id }}
#            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
#            ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·ĞµÑ€Ğµ Ğ½Ğ¾Ñ€Ğ¼
#
#  # Ğ¨Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
#  sms_error:
#    runs-on: ubuntu-latest
#    if: failure()  # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² ÑĞ»ÑƒÑ‡Ğ°Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
#    steps:
#      - name: send error telega
#        uses: appleboy/telegram-action@master
#        with:
#          to: 360209578, phpcat,
#          token: ${{ secrets.TELEGRAM_TOKEN }}
#          message: |
#            âŒâŒâŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ${{ github.repository }}
#            Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: ${{ github.event_name }} > ${{ github.event.head_commit.message }}
#            ĞÑˆĞ¸Ğ±ĞºÑƒ Ğ²Ñ‹Ğ·Ğ²Ğ°Ğ»: ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} (${{ github.run_id }})
