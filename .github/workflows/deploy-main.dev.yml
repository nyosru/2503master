name: Deploy to VPS


env:
  VPS_HOST: 91.218.230.97
  VPS_USERNAME: root
  DIR: /home/proc-master
  GIT_BRANCH: origin/main
  GITHUB_USERNAME: nyosru
  GIT_REPO: proc-master.git


on:
  push:
    branches:
      - main  # Замените на нужную ветку

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug SSH
        run: |
          echo "Checking SSH connection..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/proc-master_key
          chmod 600 ~/.ssh/proc-master_key
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/proc-master_key -o StrictHostKeyChecking=no root@${{ env.VPS_HOST }} "echo 'SSH to VPS successful'"

      - name: Deploy Code to VPS
        run: |
          ssh -i ~/.ssh/proc-master_key -o StrictHostKeyChecking=no root@${{ env.VPS_HOST }} << 'EOF'
            echo "Changing directory to /home/proc-master..."
            cd /home/proc-master || exit 1

            echo "Checking current Git remote..."
            git remote -v

            echo "Setting remote to SSH..."
            git remote set-url origin git@github.com:${{ env.GITHUB_USERNAME }}/${{ env.GIT_REPO }}

            echo "Fetching latest changes..."
            git fetch --all

            echo "Resetting to latest commit..."
            git reset --hard origin/main

            echo "Deployment complete!"
          EOF
